---
title: ğŸ¥œ [NextJS] Zod ë¥¼ í™œìš©í•œ validation check
date: 2024-04-03 12:30:00 +0800
categories: [Frontend, NextJS]
tags: [Frontend, NextJS, TypeScript]
---

> library ì¤‘ `Zod` ë¥¼ í™œìš©í•œ validation ì— ëŒ€í•´ ì•Œì•„ë³´ëŠ” í¬ìŠ¤íŠ¸ ì…ë‹ˆë‹¤.


## ê°œìš”

ìš”ì¦˜ ~~í•œê°€ë¡œì´~~ `NextJS 14`ì— ëŒ€í•´ ë°°ì›Œë‚˜ê°€ëŠ” ì¤‘...

`NextJS 14`ì—ì„œëŠ” `Server Action` ê³¼ `Zod` ë¥¼ í™œìš©í•´ API ì—°ê²°ì„

ë³´ë‹¤ ë” ê°„ê²°í•˜ê²Œ í•œë‹¤ëŠ” ë§ì„ ë“£ê³  ì•Œì•„ë³´ê²Œ ë˜ì—ˆë‹¤.

ë¨¼ì € `Server Action` ì— ëŒ€í•´ ì•Œì•„ë³´ì

<br/>
<hr/>

## Server Action ì´ë€

> ê°„ë‹¨í•˜ê²Œ ë§í•´ ì„œë²„ì—ì„œ ì‘ë™í•˜ê²Œë” í•˜ëŠ” ê²ƒ
{: .prompt-tip}

ê·¸ë ‡ë‹¤. ëœ»í’€ì´ ê·¸ëŒ€ë¡œ ì„œë²„ì—ì„œ êµ¬ë™ ê°€ëŠ¥í•˜ê²Œ í•˜ëŠ” ê²ƒì´ë‹¤.

ì—¬íƒœ í˜„ëŒ€ ì›¹ì˜ API í†µì‹ ì„ ë³´ë©´

```ts
//api.ts
export default async function getData() {
  return axios.get()...
}
```

ì´ëŸ° ì‹ìœ¼ë¡œ `api` ë¥¼ ë”°ë¡œ ê´€ë¦¬í•˜ëŠ” íŒŒì¼ì„ ìƒì„±í•´

í•¨ìˆ˜ë“¤ì„ ì§‘ì–´ë„£ê³¤ í•œë‹¤.

ê·¸ëŸ¬ë‹¤ ë³´ë‹ˆ `api` í•¨ìˆ˜ë¥¼ ì™¸ë¶€ë¡œë¶€í„° ê´€ë¦¬í•˜ê¸°ë„ ì–´ë ¤ì›Œì§„ë‹¤.

í•˜ì§€ë§Œ `Next 14` ì—ì„œëŠ” ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤ê³  í•œë‹¤.

ì• ì´ˆì— api ì— ì ‘ê·¼í•˜ëŠ” ê²ƒì„ `Server` ì—ì„œë§Œ ì‘ë™í•˜ê²Œ í•˜ëŠ” ê²ƒì´ë‹¤.

| "use server" | "use client" |
|:-------------|:-------------|
|ì„œë²„ ì¸¡ì—ì„œ êµ¬ë™| í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ êµ¬ë™|


```ts
"use server";

/**
 * preState ëŠ” ì´ˆê¸°ê°’, formData ëŠ” ì „ì†¡í•  ë°ì´í„°
*/
export default async function onSubmit(prevState: any, formData: FormData) {
  "use server";
  // ì„œë²„ ë‚´ì—ì„œë§Œ ì‘ë™ë˜ëŠ” í•¨ìˆ˜
  console.log("SEND FORM");

  await new Promise((resolve) => setTimeout(resolve, 5000));
  // ì„ì‹œë¡œ ë§Œë“  api í•¨ìˆ˜ ëŒ€ìš©. í†µì‹  ë”œë ˆì´ë¥¼ 5ì´ˆë¥¼ ì¤€ë‹¤
  // redirect("/");

  return {
    errors: ["wrong password", "password too short"],
    // ì„ì‹œ ì—ëŸ¬ ëª©ë¡ ë°˜í™˜
  };
}
```

ê·¸ í›„ ìš”ì²­ì´ ì§„í–‰ ì¤‘ì¸ì§€, ìš”ì²­ì´ ë§Œë£Œë˜ì—ˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ì•Œê¸°ìœ„í•´

`useFormState` ì™€ `useFormStatus` ë¥¼ í™œìš©í•œë‹¤.

### useFormState

- í”íˆ ì•„ëŠ” `useState` ì™€ ì‚¬ìš© ë°©ë²•ì´ ë¹„ìŠ·í•˜ë‹¤.
- `action` ë°œìƒ ì‹œ ì‘ë™í•  í•¨ìˆ˜ í•˜ë‚˜ì™€ ê°’ì„ ê°€ì ¸ì˜¬ ì´ˆê¸° ê°’ì„ ë§¤ê°œë³€ìˆ˜ë¡œ ê°€ì ¸ì•¼ í•œë‹¤.

```ts
//  ì¸í„°ë™í‹°ë¸Œ í•œ ë™ì‘ì´ë¯€ë¡œ
"use client";

/* ìƒ ëµ */

/*
1. "use client"
2. form ì œì¶œ ì‹œ ì‘ë™í•  action ê³¼ ì´ˆê¸°ê°’ state ë“±ë¡
3. form action ì— ê±¸ì–´ì£¼ë©´ ë!
*/

export default function Login() {
  const [state, action] = useFormState(onSubmit, null);
  return (
    <div>
      <form action={action} className="flex flex-col gap-3">
      // form ì˜ action ì— useFormState action ì„ ê±¸ì–´ì¤€ë‹¤!
        <Input
          type={"email"}
          placeholder={"Email"}
          required={true}
          name={"email"}
        />
        <Input
          type={"password"}
          placeholder={"Password"}
          required={true}
          name={"password"}
        />

        <FormButton text={"Login"} />
      </form>
      <SocialLogin />
    </div>
  );
}
```

### useFormStatus

- ì£¼ë¡œ `<form>` ë‚´ `<button>` ì— ê±¸ë©° í˜„ì¬ form ì˜ ì „ì†¡ ìƒíƒœë¥¼ ì•Œì•„ë³¼ ìˆ˜ ìˆë‹¤.
- `pending` ì´ë¼ëŠ” `boolean` íƒ€ì… ë³€ìˆ˜ë¥¼ í™œìš©í•´ ê°’ì„ ì œì–´í•œë‹¤.

```ts
"use client";

/*
1. "use client"
2. const { pending } = useFormStatus();
3. pending ìœ¼ë¡œ ìƒíƒœë™ì‘ì„ ì²´í¬í•  ìˆ˜ ìˆë‹¤.
*/

interface IFormButtonProps {
  text: string;
}

export default function FormButton({ text }: IFormButtonProps) {
  const { pending } = useFormStatus();
  // action ì´ ëë‚¬ëŠ”ì§€ ì—¬ë¶€ë¥¼ ì•Œ ìˆ˜ ìˆìŒ

  return (
    <button
      disabled={pending}
    >
      {pending ? "ë¡œë”© ì¤‘ ..." : text}
    </button>
  );
}
```

![image-01](../assets/img/2024-04-02/image-02.png){: .w-50 }
_(server ë‚´ì—ì„œ ì •ìƒì ìœ¼ë¡œ ê°’ì´ ë“¤ì–´ì˜¤ëŠ” ëª¨ìŠµ)_

ì—¬íƒœ ê» `state` ë¥¼ í†µí•´ form ê°’ì„ ê´€ë¦¬í•´ì„œ object ë¡œ ì „ë‹¬í•´ì™”ì—ˆëŠ”ë°

ì •ë§ ì‹ ê¸°í•œ ë°©ë²•ì´ë‹¤.. ê¸°ì¡´ì˜ ë°©ë²•ì¸ api ë³´ë‹¤ í›¨ì”¬ í¸í•˜ê¸°ë„í•˜ê³ 

ì„œë²„ ì¸¡ì—ì„œë§Œ ë™ì‘ì´ ëœë‹¤ëŠ” ì ì´ ì •ë§ í° ë©”ë¦¬íŠ¸ ì¸ ê²ƒ ê°™ë‹¤.

ì‚¬ì‹¤ ì•„ì§ì€ ì•ˆë“œë¡œì´ë“œ í™˜ê²½ì´ë‚˜ ë‹¤ë¥¸ ì™¸ë¶€ `api` ì—ì„œëŠ” ì•„ì§ì€ ê¸°ì¡´ì˜

ë°©ë²•ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒ ê°™ì§€ë§Œ ë§¤ìš° ìœ ìš©í•œ ë°©ë²•ì¸ ê²ƒ ê°™ë‹¤.


<br/>
<hr/>

## Zod ë€?

![image-02](../assets/img/2024-04-02/image-03.png){: .w-50 }
_[(ê³µì‹ í™ˆí˜ì´ì§€ ë§í¬)](https://zod.dev/)_

ë“œë””ì–´ ëŒ€ë§ì˜ ë‚´ê°€ ì´ í¬ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ëŠ” ì´ìœ ê°€ ì°¾ì•„ì™”ë‹¤.

ì¼ë‹¨ `Zod` ê°€ ë¬´ì—‡ì´ëƒë©´

>  ìŠ¤í‚¤ë§ˆ ì„ ì–¸ì„ í†µí•œ ìœ íš¨ì„± ê²€ì‚¬ ë¼ì´ë¸ŒëŸ¬ë¦¬
{: .prompt-tip}

ë¼ê³  í•œë‹¤. ë” ìì„¸íˆ ì•Œì•„ë³´ì.

<br/>
<hr/>

### ì‚¬ìš©í•˜ëŠ” ì´ìœ 

`zod` ë¥¼ ìì£¼ í™œìš©í•˜ëŠ” ì´ìœ ëŠ” `TypeScript`ì˜ í•œê³„ ë•Œë¬¸ì´ë¼ê³  í•œë‹¤

`TypeScript`ëŠ” ì»´íŒŒì¼ ì‹œì ì—ì„œì˜ íƒ€ì…ì—ëŸ¬ë§Œ ì¡ì•„ë‚¼ ìˆ˜ ìˆê³ 

ëŸ°íƒ€ì„ ë‹¨ê³„ì—ì„œì˜ íƒ€ì… ì—ëŸ¬ëŠ” ì–´ì©” ë°©ë„ê°€ ì—†ë‹¤.

ì™œëƒë©´ ëŸ°íƒ€ì„ ë‹¨ê³„ì—ì„œ ì‘ë™ë˜ëŠ” ê²ƒì€ `JavaScript` ì´ê¸° ë•Œë¬¸ì´ë‹¤.

ë˜í•œ ì›í•˜ëŠ” ë¬¸ìì—´ì´ë‚˜ ì›í•˜ëŠ” ìˆ«ì ë²”ìœ„ë¥¼ ê°•ì œí•˜ê±°ë‚˜ `number`

íƒ€ì…ì˜ ì •ìˆ˜/ì‹¤ìˆ˜ êµ¬ë¶„ì€ ë¶ˆê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— TypeScript ì—ì„œì˜

í•œê³„ë¥¼ ê·¹ë³µí•˜ê¸° ìœ„í•´ ìš”ì¦˜ì€ `Zod` ë¥¼ ìì£¼ í™œìš©í•œë‹¤ê³  í•œë‹¤.

### ì„¤ì¹˜ ë°©ë²•

```terminal
npm install zod
```

### ìŠ¤í‚¤ë§ˆ í˜•íƒœë¡œ ì •ì˜

```ts
"use server";
import { z } from "zod";

// zod ëŠ” validation ì„ schema í˜•ì‹ìœ¼ë¡œ ê²€ì¦í•¨
const formSchema = z
  .object({
    username: z
      .string()
      .min(3)
      .max(10)
      .toLowerCase()
      .trim(),
    email: z
      .string()
      .email()
      .toLowerCase()
      .trim(),
    password: z
      .string()
      .min(10),
    confirmPassword: z.string(),
  });
```

`Zod` ëŠ” ë°ì´í„° í˜•ì‹ì„ Schema í˜•íƒœë¡œ ì €ì¥ ë° ê´€ë¦¬í•œë‹¤.

ë§¤ìš° ì§ê´€ì ì´ë‹¤. í•´ë‹¹í•˜ëŠ” ê°’ì´ `Schema` ì— ì í•©í•œì§€ ì—¬ë¶€ë¥¼ í™•ì¸í•  ë•

`parse()` ì™€ `safeParse()` ë¥¼ ì‚¬ìš©í•œë‹¤.

|parse()|safeParse()|
|:------|:----------|
|ì—ëŸ¬ë¥¼ ë°˜í™˜|ì—ëŸ¬ë¥¼ ë°˜í™˜í•˜ì§€ ì•ŠìŒ|

ì´ë¼ëŠ” ì°¨ì´ì ì´ ì¡´ì¬í•˜ëŠ”ë°, ë‘ê°œëŠ” ê±°ì§„ ì·¨í–¥ ì°¨ì´ì¸ ê²ƒ ê°™ë‹¤.

ë‚˜ëŠ” ì´ë²ˆì—” ê¸°ì¡´ì˜ `api` êµ¬ë¬¸ì²˜ëŸ¼ `try-catch` ë¬¸ì„ ìµœì†Œí™” í•´ë³´ê³  ì‹¶ì–´

`safeParse()` ë¥¼ í™œìš©í–ˆë‹¤.

```ts
/*
1. í•´ë‹¹ ìŠ¤í‚¤ë§ˆì— ì í•©í•œì§€ parsing
2. ì„±ê³µí•˜ë©´ success ì´ë¯€ë¡œ ì—ëŸ¬ í•¸ë“¤ë§
3. flatten í•¨ìˆ˜ë¡œ ì—ëŸ¬ë¥¼ ë³´ê¸°í¸í•˜ê²Œ ë¦¬í¼
*/
  let result = formSchema.safeParse(data);
  // error ë¥¼ ë°˜í™˜í•˜ì§€ ì•ŠìŒ
  if (!result.success) {
    console.log(result.error.flatten());
    return result.error.flatten();
  } else {
    console.log(data);
  }
```

í•´ë‹¹ ìŠ¤í‚¤ë§ˆì— ë§ì§€ ì•ŠëŠ” êµ¬ë¬¸ì´ ìƒê¸°ë©´ ì—ëŸ¬ê°€ ì½˜ì†”ì— ì°íŒë‹¤.

```terminal
  issues: [
    {
      code: 'invalid_type',
      expected: 'string',
      received: 'null',
      path: [Array],
      message: 'Expected string, received null'
    },

 <!-- ìƒëµ -->
{
  formErrors: [],
  fieldErrors: {
    username: [ 'Expected string, received null' ],
    password: [ 'String must contain at least 10 character(s)' ],
    confirmPassword: [ 'String must contain at least 10 character(s)' ]
  }
}

<!-- flatten() ìœ¼ë¡œ reform í•œ ê°’ -->
```

ìš°ë¦¬ëŠ” ì—¬ê¸°ì— ì¶”ê°€ë¡œ `validation` ì„ ìƒì„¸í•˜ê²Œ ì ì„ ìˆ˜ ìˆë‹¤.

### ì½”ë“œ ì˜ˆì‹œ

```ts
"use server";
import { z } from "zod";

const passwordRegex = new RegExp(
  /^(?=.*?[A-Z])(?=.*?[a-z])(?=.*?[0-9])(?=.*?[#?!@$%^&*-]).+$/
);

// zod ëŠ” validation ì„ schema í˜•ì‹ìœ¼ë¡œ ê²€ì¦í•¨
const formSchema = z
  .object({
    username: z
      .string({
        invalid_type_error: "í˜•ì‹ì´ í‹€ë¦½ë‹ˆë‹¤.",
        required_error: "ìœ ì € ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.",
      })
      .min(3, "ìœ ì € ëª…ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤.")
      .max(10, "ìœ ì € ëª…ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤.")
      .toLowerCase()
      .trim(),
    email: z
      .string({
        invalid_type_error: "í˜•ì‹ì´ í‹€ë¦½ë‹ˆë‹¤.",
        required_error: "ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.",
      })
      .email({
        message: "ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.",
      })
      .toLowerCase()
      .trim(),
    password: z
      .string({
        invalid_type_error: "í˜•ì‹ì´ í‹€ë¦½ë‹ˆë‹¤.",
        required_error: "ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.",
      })
      .min(10, {
        message: "ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤.",
      })
      .regex(passwordRegex, {
        message:
          "ë¹„ë°€ë²ˆí˜¸ëŠ” ìˆ«ì, ëŒ€ë¬¸ì, ì†Œë¬¸ì, íŠ¹ìˆ˜ê¸°í˜¸ë¥¼ í¬í•¨í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.",
      }),
    confirmPassword: z.string(),
  })
  .refine((data) => data.confirmPassword === data.password, {
    message: "ë¹„ë°€ë²ˆí˜¸ê°€ ì„œë¡œ ë‹¤ë¦…ë‹ˆë‹¤.",
    path: ["confirmPassword"],
  });
  // refine() ìœ¼ë¡œ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ì „ì²´ì ìœ¼ë¡œ ì§„í–‰ì´ ê°€ëŠ¥í•˜ë©°
  // path ë¡œ ì—ëŸ¬ì˜ ìœ„ì¹˜ë¥¼ ë°˜í™˜í•´ì¤„ ìˆ˜ ìˆìŒ

export default async function createAccount(preState: any, formData: FormData) {
  const data = {
    username: formData.get("username"),
    email: formData.get("email"),
    password: formData.get("password"),
    confirmPassword: formData.get("confirmPassword"),
  };

  let result = formSchema.safeParse(data);
  // error ë¥¼ ë°˜í™˜í•˜ì§€ ì•ŠìŒ
  if (!result.success) {
    console.log(result.error.flatten());
    return result.error.flatten();
  } else {
    console.log(data);
  }
}
```

## ë§ˆì¹˜ë©°

~~ì§„ì§œ êµ‰ì¥íˆ í¸í•˜ë‹¤ Next ì“°ëŠ” ì´ìœ ê°€ ìˆë„¤~~

Zod ë¥¼ ì²˜ìŒ ë³¼ë• ìƒì†Œí•˜ê¸°ë„ í•˜ê³  êµ³ì´ ì¨ì•¼í•˜ë‚˜ ì‹¶ì—ˆëŠ”ë°,

`Validation` ì€ ì‹ ì¤‘í•˜ê³  ì •í™•í•´ì•¼ í•˜ëŠ”ë° ì»´íŒŒì¼ ë‹¨ê³„ ë¿ë§Œì´ ì•„ë‹Œ

ëŸ°íƒ€ì„ì—ì„œë„ ë™ì‘í•œë‹¤ëŠ” ê²ƒì´ ì°¸ ë©”ë¦¬íŠ¸ê°€ ì»¸ë‹¤.

ì—­ì‹œ ê¸°ìˆ ì´ ìˆìœ¼ë©´ ~~ì°ë¨¹ì€~~ í•œë²ˆ ì”© í•´ë´ì•¼í•œë‹¤ëŠ” ê±¸ ëŠë‚€ë‹¤.